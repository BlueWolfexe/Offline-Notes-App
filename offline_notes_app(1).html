<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Notes ‚Äî Class ‚Üí Lesson ‚Üí Section</title>
<style>
  :root{
    --bg: #0b1220;
    --bg-2:#111a2e;
    --panel:#121c33;
    --panel-2:#17223b;
    --text:#e6edf6;
    --muted:#92a1b7;
    --brand:#6ea8fe;
    --brand-2:#3f7dff;
    --accent:#9dffad;
    --danger:#ff6b6b;
    --yellow:#ffe082;
    --ring: rgba(110,168,254,.35);
  }
  *{box-sizing: border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
    background: radial-gradient(1200px 800px at 30% -200px, #21365e 0%, transparent 70%),
                linear-gradient(180deg, var(--bg) 0%, #0a111f 100%);
    color: var(--text);
  }
  .app{display:flex; flex-direction:column; height:100%}
  /* Top taskbar */
  .topbar{
    display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem;
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
    border-bottom:1px solid rgba(255,255,255,.06);
    position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
  }
  .crumbs{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; font-size:.95rem}
  .crumb{display:inline-flex; align-items:center; gap:.4rem; background: var(--panel); border:1px solid rgba(255,255,255,.08);
    padding:.35rem .6rem; border-radius:.5rem; cursor:pointer;}
  .crumb[aria-current="page"]{background: var(--brand-2); border-color: var(--brand-2); color:#fff; cursor:default}
  .sep{opacity:.5}
  .actions{margin-left:auto; display:flex; gap:.5rem; align-items:center;}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.15); background: var(--panel);
    color:var(--text); padding:.5rem .75rem; border-radius:.5rem; cursor:pointer; font-weight:600; font-size:.9rem;}
  .btn:hover{border-color:var(--brand); box-shadow: 0 0 0 3px var(--ring)}
  .btn.primary{background: linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%); border-color:transparent; color:#051028}
  .btn.danger{background:#3b0f16; border-color:#5b1823; color:#ff98a4}
  .search{position:relative; display:flex; align-items:center;}
  .search input{
    height:2.25rem; width:26ch; border-radius:.6rem; border:1px solid rgba(255,255,255,.15);
    background: var(--panel); color:var(--text); padding:.45rem .75rem .45rem 2.1rem; outline:none;
  }
  .search input:focus{border-color: var(--brand); box-shadow: 0 0 0 3px var(--ring)}
  .search .icon{position:absolute; left:.55rem; opacity:.6; font-size:1rem}
  /* Main */
  .main{display:grid; grid-template-rows:auto 1fr; height:calc(100% - 58px);}
  .header-rail{padding:.75rem 1rem; display:flex; align-items:center; gap:.5rem; border-bottom:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));}
  .header-rail h2{margin:0; font-size:1rem; font-weight:700; letter-spacing:.02em; opacity:.9}
  .meta{color: var(--muted); font-size:.9rem}
  .center{height:100%; overflow:auto; padding:1rem; display:grid; place-items:start center;}
  .list{width:min(1200px, 92vw); display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:.75rem;}
  .row{background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid rgba(255,255,255,.08);
    border-radius:.9rem; padding:.9rem; display:flex; gap:.75rem; align-items:flex-start; min-height:64px; cursor:pointer; position:relative; outline:none;}
  .row[data-selected="true"]{box-shadow:0 0 0 3px var(--ring); border-color: var(--brand)}
  .row .title{font-weight:700}
  .row .sub{font-size:.85rem; color:var(--muted)}
  .row .grow{flex:1}
  .row .icons{display:flex; gap:.35rem}
  .icon-btn{border:none; background:transparent; color:var(--muted); cursor:pointer; padding:.25rem; border-radius:.4rem;}
  .icon-btn:hover{color:#fff; background:rgba(255,255,255,.06)}
  .muted{color:var(--muted)}
  .empty{width:min(1000px, 92vw); margin:4rem auto; text-align:center; color:var(--muted);}
  .kbd{display:inline-block; border:1px solid rgba(255,255,255,.2); padding:.15rem .35rem; border-radius:.3rem; font-size:.8rem; background:rgba(255,255,255,.06)}
  /* Notes */
  .notes-wrap{width:min(1000px, 92vw); margin:0 auto; display:flex; flex-direction:column; gap:.75rem}
  .note{background:#18243f; border:1px solid rgba(255,255,255,.1); border-left:4px solid var(--yellow); border-radius:.6rem; padding:.8rem .8rem .6rem; position:relative;}
  .note .when{font-size:.75rem; color:#9fb0ca; margin-top:.35rem}
  .note .text{white-space:pre-wrap; line-height:1.45}
  .note .bar{position:absolute; top:.45rem; right:.45rem; display:flex; gap:.25rem;}
  .note.editing{outline:2px dashed var(--brand); background:#12213f}
  .composer{margin-top:.5rem; background:#111a30; border:1px dashed rgba(110,168,254,.5); border-radius:.6rem; padding:.5rem;}
  textarea.input, textarea.edit{width:100%; min-height:120px; resize:vertical; border:none; outline:none; color:var(--text); background:transparent; font:inherit; line-height:1.5;}
  .composer .row-actions{display:flex; gap:.5rem; justify-content:flex-end; padding:.35rem;}
  .hint{text-align:center; color:var(--muted); font-size:.9rem; padding:.5rem 0;}
  /* Search panel */
  .search-panel{position:fixed; top:56px; right:12px; width:min(560px, 88vw); max-height:70vh; overflow:auto; background:#0b1429; border:1px solid rgba(255,255,255,.15); border-radius:.75rem; box-shadow:0 16px 40px rgba(0,0,0,.45); display:none;}
  .search-panel header{padding:.6rem .75rem; border-bottom:1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center}
  .result{padding:.7rem .8rem; border-bottom:1px dashed rgba(255,255,255,.08); cursor:pointer}
  .result:hover{background:rgba(255,255,255,.05)}
  .result .path{color:var(--muted); font-size:.85rem}
  .result .snippet{margin-top:.15rem}
  .badge{display:inline-block; padding:.1rem .4rem; border-radius:.4rem; background:#12213f; border:1px solid rgba(255,255,255,.12); font-size:.8rem; color:#c9d7ee}
  /* Icons */
  .i{width:1em;height:1em;display:inline-block;vertical-align:-0.15em}
  .i-pen::before{content:"‚úé"}
  .i-trash::before{content:"üóë"}
  .i-plus::before{content:"Ôºã"}
  .i-left::before{content:"‚óÄ"}
  .i-right::before{content:"‚ñ∂"}
  .i-up::before{content:"‚ñ≤"}
  .i-down::before{content:"‚ñº"}
  .i-clock::before{content:"‚è±"}
  .i-search::before{content:"üîé"}
  .i-check::before{content:"‚úî"}
  .i-x::before{content:"‚úñ"}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="crumbs" id="breadcrumbs"></div>
    <div class="actions">
      <div class="search">
        <span class="icon i i-search" aria-hidden="true"></span>
        <input id="searchInput" placeholder="Search notes‚Ä¶" autocomplete="off"/>
      </div>
      <button id="addBtn" class="btn primary">Add</button>
      <button id="helpBtn" class="btn">?</button>
    </div>
  </div>

  <div class="main">
    <div class="header-rail">
      <h2 id="viewTitle">Classes</h2>
      <span id="viewMeta" class="meta"></span>
    </div>
    <div class="center">
      <div id="list" class="list" role="listbox" aria-label="Center list"></div>
      <div id="notesWrap" class="notes-wrap" style="display:none"></div>
      <div id="empty" class="empty" style="display:none">
        <p>No items here yet.</p>
        <p class="muted">Use <span class="kbd">Enter</span> to open (or create when empty), <span class="kbd">Tab</span> to go back, <span class="kbd">‚Üë/‚Üì</span> to move, and the <strong>Add</strong> button (or <span class="kbd">Ctrl/Cmd+N</span>) to create.</p>
      </div>
    </div>
  </div>
</div>

<!-- Search results panel -->
<div id="searchPanel" class="search-panel" aria-live="polite" aria-label="Search results">
  <header>
    <strong>Search results</strong>
    <span id="searchCount" class="badge">0</span>
  </header>
  <div id="searchResults"></div>
</div>

<script>
// ---------- State & Storage ----------
const STORAGE_KEY = "notesAppV2";
/** @type {{classes: Array<{id:string,name:string,lessons:Array<{id:string,name:string,sections:Array<{id:string,name:string,notes:Array<{id:string,text:string,updated:string}>}>}>}>}>} */
let data = { classes: [] };

let level = "classes"; // classes | lessons | sections | notes
let sel = { classId:null, lessonId:null, sectionId:null };
let selectedIndex = 0;
let listItemsCache = [];
let editingLock = false;
let composerOpen = false;

// ---------- Utilities ----------
const byId = id => document.getElementById(id);
const nowStamp = () => new Date().toLocaleString();
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ data = JSON.parse(raw); } }catch(e){ console.error("load", e);} }
load();

// ---------- Render ----------
const breadcrumbs = byId("breadcrumbs");
const listEl = byId("list");
const notesWrap = byId("notesWrap");
const emptyEl = byId("empty");
const viewTitle = byId("viewTitle");
const viewMeta = byId("viewMeta");
const addBtn = byId("addBtn");

function render(){
  // breadcrumbs
  breadcrumbs.innerHTML = "";
  const addCrumb = (label, active, onClick) => {
    const c = document.createElement("button");
    c.className = "crumb"; c.textContent = label; if(active) c.setAttribute("aria-current","page");
    c.addEventListener("click", () => onClick && onClick()); breadcrumbs.appendChild(c);
  };
  const addSep = () => { const s = document.createElement("span"); s.className="sep"; s.textContent = "‚Üí"; breadcrumbs.appendChild(s); };

  addCrumb("Class", level==="classes", () => gotoClasses());
  if(sel.classId){ addSep(); const cls=getClass(sel.classId); addCrumb(cls?.name||"‚Äî", level==="lessons", ()=> gotoLessons(sel.classId)); }
  if(sel.lessonId){ addSep(); const les=getLesson(sel.classId, sel.lessonId); addCrumb(les?.name||"‚Äî", level==="sections", ()=> gotoSections(sel.classId, sel.lessonId)); }
  if(sel.sectionId){ addSep(); const sec=getSection(sel.classId, sel.lessonId, sel.sectionId); addCrumb(sec?.name||"‚Äî", level==="notes", ()=> gotoNotes(sel.classId, sel.lessonId, sel.sectionId)); }

  let items = [];
  listItemsCache = [];
  notesWrap.style.display = "none";
  listEl.style.display = "grid";
  emptyEl.style.display = "none";

  if(level==="classes"){
    viewTitle.textContent = "Classes";
    items = data.classes.map(c => ({ id:c.id, title:c.name, sub:`${c.lessons.length} lessons`, type:"class" }));
    setAddBtn("Add Class", onAddClass);
  } else if(level==="lessons"){
    const cls = getClass(sel.classId);
    viewTitle.textContent = `Lessons ‚Äî ${cls?.name ?? ""}`;
    items = (cls?.lessons ?? []).map(l => ({ id:l.id, title:l.name, sub:`${l.sections.length} sections`, type:"lesson" }));
    setAddBtn("Add Lesson", () => onAddLesson(sel.classId));
  } else if(level==="sections"){
    const les = getLesson(sel.classId, sel.lessonId);
    viewTitle.textContent = `Sections ‚Äî ${les?.name ?? ""}`;
    items = (les?.sections ?? []).map(s => ({ id:s.id, title:s.name, sub:`${s.notes.length} notes`, type:"section" }));
    setAddBtn("Add Section", () => onAddSection(sel.classId, sel.lessonId));
  } else if(level==="notes"){
    const sec = getSection(sel.classId, sel.lessonId, sel.sectionId);
    viewTitle.textContent = `Notes ‚Äî ${sec?.name ?? ""}`;
    items = (sec?.notes ?? []).map(n => ({ id:n.id, title: trimTitle(n.text), sub:n.updated, type:"note" }));
    setAddBtn("New Note", () => openComposer());
  }

  viewMeta.textContent = `${items.length} ${level === "notes" ? "note" : level.slice(0,-1)}${items.length===1?"":"s"}  ‚Ä¢  Ctrl/Cmd+N to add`;

  if(level==="notes"){ renderNotes(); } else { renderList(items); }
  ensureSelection(items.length);
}

function setAddBtn(label, cb){ addBtn.textContent = label; addBtn.onclick = () => { if(!editingLock) cb(); }; }
function trimTitle(text){ const t = text.replace(/\s+/g,' ').trim(); return t.length>64 ? t.slice(0,64)+"‚Ä¶" : (t || "(empty)"); }

function renderList(items){
  listEl.innerHTML = "";
  if(items.length===0){ listEl.style.display="none"; emptyEl.style.display="block"; } else { listEl.style.display="grid"; }
  listItemsCache = items;
  items.forEach((it, idx) => {
    const row = document.createElement("div");
    row.className="row"; row.setAttribute("tabindex","0"); row.dataset.index=idx; row.dataset.id=it.id; row.dataset.kind=it.type;
    if(idx===selectedIndex) row.setAttribute("data-selected","true");
    row.innerHTML = `
      <div class="grow">
        <div class="title">${escapeHtml(it.title)}</div>
        <div class="sub">${escapeHtml(it.sub || "")}</div>
      </div>
      <div class="icons">
        <button class="icon-btn" data-action="rename" title="Rename"><span class="i i-pen"></span></button>
        <button class="icon-btn" data-action="delete" title="Delete"><span class="i i-trash"></span></button>
      </div>`;
    row.addEventListener("click", (e)=>{
      const act = e.target.closest("[data-action]")?.dataset.action;
      if(act==="rename"){ onRenameRow(it); e.stopPropagation(); return; }
      if(act==="delete"){ onDeleteRow(it); e.stopPropagation(); return; }
      selectedIndex = idx; openRow(it);
    });
    row.addEventListener("dblclick", ()=> onRenameRow(it));
    listEl.appendChild(row);
  });
}

function renderNotes(){
  listEl.style.display="none"; notesWrap.style.display="flex"; notesWrap.innerHTML="";
  const sec = getSection(sel.classId, sel.lessonId, sel.sectionId);
  const notes = sec?.notes ?? [];
  if(notes.length===0){
    const h=document.createElement("div"); h.className="hint";
    h.innerHTML=`Press <span class="kbd">Enter</span> to start typing. Save with <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>. Use <span class="kbd">Tab</span> to go back.`;
    notesWrap.appendChild(h);
  }
  notes.forEach((n)=>{
    const item = document.createElement("article");
    item.className="note"; item.dataset.id=n.id;
    item.innerHTML=`
      <div class="bar">
        <button class="icon-btn" title="Edit" data-action="edit"><span class="i i-pen"></span></button>
        <button class="icon-btn" title="Delete" data-action="delete"><span class="i i-trash"></span></button>
      </div>
      <div class="text">${escapeHtml(n.text)}</div>
      <div class="when"><span class="i i-clock"></span> ${n.updated}</div>`;
    item.addEventListener("click",(e)=>{
      const act=e.target.closest("[data-action]")?.dataset.action;
      if(act==="delete"){ onDeleteNote(n.id); e.stopPropagation(); return; }
      onEditNote(n.id);
    });
    notesWrap.appendChild(item);
  });

  const comp = document.createElement("section");
  comp.className="composer"; comp.id="composer"; comp.style.display = composerOpen? "block" : "none";
  comp.innerHTML=`
    <textarea class="input" id="composerInput" placeholder="Start typing your note‚Ä¶ (Save: Ctrl/Cmd+Enter, New line: Shift+Enter)"></textarea>
    <div class="row-actions">
      <button class="btn" id="cancelCompose"><span class="i i-x"></span> Cancel</button>
      <button class="btn primary" id="saveCompose"><span class="i i-check"></span> Save Note</button>
    </div>`;
  notesWrap.appendChild(comp);
  if(composerOpen){ const ta=byId("composerInput"); setTimeout(()=> ta?.focus(), 0); }
}

// ---------- Navigation ----------
function ensureSelection(count){
  if(level==="notes") return;
  if(count===0){ selectedIndex=0; return; }
  if(selectedIndex >= count) selectedIndex=Math.max(0, count-1);
  const nodes=[...listEl.querySelectorAll(".row")];
  nodes.forEach(n => n.removeAttribute("data-selected"));
  const active = nodes[selectedIndex];
  if(active){ active.setAttribute("data-selected","true"); active.scrollIntoView({block:"nearest"}); }
}
function openRow(it){
  if(it.type==="class") gotoLessons(it.id);
  else if(it.type==="lesson") gotoSections(sel.classId, it.id);
  else if(it.type==="section") gotoNotes(sel.classId, sel.lessonId, it.id);
}

function gotoClasses(){ level="classes"; sel={classId:null, lessonId:null, sectionId:null}; selectedIndex=0; composerOpen=false; render(); }
function gotoLessons(classId){ level="lessons"; sel.classId=classId; sel.lessonId=null; sel.sectionId=null; selectedIndex=0; composerOpen=false; render(); }
function gotoSections(classId, lessonId){ level="sections"; sel.classId=classId; sel.lessonId=lessonId; sel.sectionId=null; selectedIndex=0; composerOpen=false; render(); }
function gotoNotes(classId, lessonId, sectionId){ level="notes"; sel.classId=classId; sel.lessonId=lessonId; sel.sectionId=sectionId; composerOpen=false; render(); }

// ---------- Add helpers ----------
function onAddClass(){
  const name = prompt("Class name:");
  if(!name) return;
  data.classes.push({ id: uid(), name: name.trim(), lessons: [] });
  save(); render();
}
function onAddLesson(classId){
  const cls = getClass(classId); if(!cls) return;
  const name = prompt("Lesson name:");
  if(!name) return;
  cls.lessons.push({ id: uid(), name: name.trim(), sections: [] });
  save(); render();
}
function onAddSection(classId, lessonId){
  const les = getLesson(classId, lessonId); if(!les) return;
  const name = prompt("Section name:");
  if(!name) return;
  les.sections.push({ id: uid(), name: name.trim(), notes: [] });
  save(); render();
}
function addAtCurrentLevel(){
  if(level==="classes") onAddClass();
  else if(level==="lessons") onAddLesson(sel.classId);
  else if(level==="sections") onAddSection(sel.classId, sel.lessonId);
  else if(level==="notes") openComposer();
}

// ---------- Rename/Delete items ----------
function onRenameRow(it){
  if(editingLock) return;
  const label = it.type[0].toUpperCase()+it.type.slice(1);
  const next = prompt(`Rename ${label}:`, it.title||"");
  if(next===null || !next.trim()) return;
  if(it.type==="class"){ const c=getClass(it.id); if(c) c.name=next.trim(); }
  if(it.type==="lesson"){ const l=getLesson(sel.classId, it.id); if(l) l.name=next.trim(); }
  if(it.type==="section"){ const s=getSection(sel.classId, sel.lessonId, it.id); if(s) s.name=next.trim(); }
  save(); render();
}
function onDeleteRow(it){
  const label = it.type;
  if(!confirm(`Delete this ${label}? This can‚Äôt be undone.`)) return;
  if(it.type==="class"){
    data.classes = data.classes.filter(c=>c.id!==it.id);
    if(sel.classId===it.id) gotoClasses();
  } else if(it.type==="lesson"){
    const cls=getClass(sel.classId); if(!cls) return;
    cls.lessons = cls.lessons.filter(l=>l.id!==it.id);
    if(sel.lessonId===it.id) gotoLessons(sel.classId);
  } else if(it.type==="section"){
    const les=getLesson(sel.classId, sel.lessonId); if(!les) return;
    les.sections = les.sections.filter(s=>s.id!==it.id);
    if(sel.sectionId===it.id) gotoSections(sel.classId, sel.lessonId);
  }
  save(); render();
}

// ---------- Notes CRUD ----------
function openComposer(){ if(level!=="notes") return; composerOpen=true; render(); }
function closeComposer(){ composerOpen=false; render(); }
function saveComposer(){
  const ta = byId("composerInput"); if(!ta) return;
  const text = ta.value.trim(); if(!text){ ta.focus(); return; }
  const sec = getSection(sel.classId, sel.lessonId, sel.sectionId); if(!sec) return;
  sec.notes.unshift({ id: uid(), text, updated: nowStamp() });
  save(); composerOpen=false; render();
}
function onDeleteNote(noteId){
  if(!confirm("Delete this note?")) return;
  const sec = getSection(sel.classId, sel.lessonId, sel.sectionId); if(!sec) return;
  sec.notes = sec.notes.filter(n=>n.id!==noteId);
  save(); render();
}
function onEditNote(noteId){
  if(editingLock) return;
  const node = notesWrap.querySelector(`.note[data-id="${noteId}"]`); if(!node) return;
  const note = getSection(sel.classId, sel.lessonId, sel.sectionId)?.notes.find(n=>n.id===noteId); if(!note) return;
  editingLock=true; node.classList.add("editing");
  const txt = node.querySelector(".text"); const origHtml = txt.innerHTML;
  txt.innerHTML = `<textarea class="edit" id="editArea">${escapeHtml(note.text)}</textarea>
    <div class="row-actions" style="text-align:right; margin-top:.35rem">
      <button class="btn" id="cancelEdit"><span class="i i-x"></span> Cancel</button>
      <button class="btn primary" id="saveEdit"><span class="i i-check"></span> Save</button>
    </div>`;
  const ta = byId("editArea"); ta.focus(); placeCaretEnd(ta);
  byId("cancelEdit").onclick = ()=>{ editingLock=false; node.classList.remove("editing"); txt.innerHTML=origHtml; };
  byId("saveEdit").onclick = ()=>{
    note.text = ta.value.trim(); note.updated = nowStamp(); save(); editingLock=false; render();
  };
  ta.addEventListener("keydown", (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); byId("saveEdit").click(); }
    if(e.key==="Escape"){ e.preventDefault(); byId("cancelEdit").click(); }
  });
}

// ---------- Keyboard Shortcuts ----------
document.addEventListener("keydown", (e)=>{
  const activeEl = document.activeElement;
  const isTyping = editingLock || composerOpen || activeEl?.tagName === "INPUT" || activeEl?.tagName === "TEXTAREA";

  // Ctrl/Cmd + N adds at current level
  if((e.ctrlKey||e.metaKey) && (e.key==='n' || e.key==='N')){ e.preventDefault(); if(!editingLock) addAtCurrentLevel(); return; }

  // Tab ‚Äî go back a level
  if(e.key === "Tab" && !e.shiftKey && !isTyping){ e.preventDefault(); navBack(); return; }

  if(isTyping) return;

  if(level!=="notes"){
    const count = listItemsCache.length;
    if(e.key==="ArrowDown"){ e.preventDefault(); if(count){ selectedIndex = Math.min(selectedIndex+1, count-1); ensureSelection(count);} }
    if(e.key==="ArrowUp"){ e.preventDefault(); if(count){ selectedIndex = Math.max(selectedIndex-1, 0); ensureSelection(count);} }
    if(e.key==="Enter" || e.key==="ArrowRight"){
      e.preventDefault();
      const it = listItemsCache[selectedIndex];
      if(it){ openRow(it); } else { addAtCurrentLevel(); } // if list empty, create
    }
    if(e.key==="Delete"){
      const it = listItemsCache[selectedIndex]; if(it) onDeleteRow(it);
    }
  } else {
    // notes view
    if(e.key==="Enter"){ e.preventDefault(); openComposer(); }
    if(e.key==="ArrowLeft"){ e.preventDefault(); navBack(); }
  }
});

function navBack(){
  if(level==="notes") gotoSections(sel.classId, sel.lessonId);
  else if(level==="sections") gotoLessons(sel.classId);
  else if(level==="lessons") gotoClasses();
  else gotoClasses();
}

// Composer buttons + shortcuts
document.addEventListener("click", (e)=>{
  const id = e.target.id;
  if(id==="saveCompose") saveComposer();
  if(id==="cancelCompose") closeComposer();
});
document.addEventListener("keydown", (e)=>{
  if(!composerOpen) return;
  const ta = byId("composerInput"); if(!ta) return;
  if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); saveComposer(); }
  if(e.key==="Escape"){ e.preventDefault(); closeComposer(); }
});

// ---------- Search ----------
const searchInput = byId("searchInput");
const searchPanel = byId("searchPanel");
const searchResults = byId("searchResults");
const searchCount = byId("searchCount");
let searchDebounce = 0;

searchInput.addEventListener("input", ()=>{
  clearTimeout(searchDebounce);
  const q = searchInput.value.trim().toLowerCase();
  if(!q){ searchPanel.style.display="none"; return; }
  searchDebounce = setTimeout(()=> runSearch(q), 120);
});

function runSearch(q){
  const matches = [];
  for(const cls of data.classes){
    for(const les of cls.lessons){
      for(const sec of les.sections){
        for(const note of sec.notes){
          if(note.text.toLowerCase().includes(q)){
            matches.push({
              classId: cls.id, lessonId: les.id, sectionId: sec.id, noteId: note.id,
              path: `${cls.name} ‚Üí ${les.name} ‚Üí ${sec.name}`,
              snippet: makeSnippet(note.text, q)
            });
          }
        }
      }
    }
  }
  searchCount.textContent = matches.length;
  searchResults.innerHTML = matches.map(m => `
    <div class="result" data-class="${m.classId}" data-lesson="${m.lessonId}" data-section="${m.sectionId}" data-note="${m.noteId}">
      <div class="path">${escapeHtml(m.path)}</div>
      <div class="snippet">${highlight(m.snippet, q)}</div>
    </div>`).join("");
  [...searchResults.children].forEach(el => {
    el.addEventListener("click", ()=>{
      gotoNotes(el.dataset.class, el.dataset.lesson, el.dataset.section);
      setTimeout(()=>{
        const target = notesWrap.querySelector(`.note[data-id="${el.dataset.note}"]`);
        if(target){
          target.style.outline = "2px solid var(--accent)";
          target.scrollIntoView({block:"center"});
          setTimeout(()=> target.style.outline = "", 900);
        }
      }, 60);
      searchPanel.style.display = "none";
    });
  });
  searchPanel.style.display = "block";
});

document.addEventListener("click", (e)=>{
  if(!searchPanel.contains(e.target) && e.target !== searchInput){
    searchPanel.style.display = "none";
  }
});

// ---------- Small helpers ----------
function getClass(classId){ return data.classes.find(c => c.id===classId); }
function getLesson(classId, lessonId){ return getClass(classId)?.lessons.find(l => l.id===lessonId); }
function getSection(classId, lessonId, sectionId){ return getLesson(classId, lessonId)?.sections.find(s => s.id===sectionId); }

function escapeHtml(s=""){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function makeSnippet(text, q){
  const s = text; const idx = s.toLowerCase().indexOf(q);
  if(idx<0) return s.length>120 ? s.slice(0,120)+"‚Ä¶" : s;
  const start = Math.max(0, idx-40), end = Math.min(s.length, idx+q.length+40);
  return (start>0?"‚Ä¶":"") + s.slice(start,end) + (end<s.length?"‚Ä¶":"");
}
function highlight(snippet, q){
  return escapeHtml(snippet).replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi"),
    (m)=> `<mark style="background: #3b5cb5; color: #fff; padding:0 .15rem; border-radius:.2rem">${m}</mark>`);
}
function placeCaretEnd(el){ el.focus(); el.selectionStart = el.selectionEnd = el.value.length; }

// ---------- Wire controls ----------
addBtn.addEventListener("click", ()=> addAtCurrentLevel());
byId("helpBtn").addEventListener("click", ()=>{
  alert([
    "Keyboard:",
    "  ‚Ä¢ Enter ‚Äî open (or start typing in Notes); when a list is empty: create",
    "  ‚Ä¢ Arrow ‚Üë/‚Üì ‚Äî move selection",
    "  ‚Ä¢ Arrow ‚Üí ‚Äî open",
    "  ‚Ä¢ Tab ‚Äî go back one group",
    "  ‚Ä¢ Delete ‚Äî delete selected row",
    "  ‚Ä¢ Ctrl/Cmd+N ‚Äî add at current level (Class/Lesson/Section or New note)",
    "",
    "Notes:",
    "  ‚Ä¢ Enter ‚Äî open composer",
    "  ‚Ä¢ Ctrl/Cmd+Enter ‚Äî save note",
    "  ‚Ä¢ Click note ‚Äî edit",
    "  ‚Ä¢ Esc ‚Äî cancel composer/edit"
  ].join("\\n"));
});

// ---------- Boot ----------
if(data.classes.length===0){
  const c = { id: uid(), name: "Sample Class", lessons: [] };
  const l = { id: uid(), name: "Intro Lesson", sections: [] };
  const s = { id: uid(), name: "Week 1", notes: [] };
  s.notes.push({ id: uid(), text: "Welcome! Press Enter to add a note.\nUse Tab to go back to Lessons and Classes.", updated: nowStamp() });
  l.sections.push(s); c.lessons.push(l); data.classes.push(c); save();
}
gotoClasses();
</script>
</body>
</html>
